summary: Try different compression algorithms set in snapcraft.yaml

environment:
  COMPRESSION: xz
  COMPRESSION/lzo: lzo
  COMPRESSION/xz: xz
  SNAPCRAFT_BUILD_ENVIRONMENT: ""
  COMMAND: "pack"
  COMMAND/default: ""
  COMMAND/pack: "pack"

prepare: |
  mkdir test-snap
  cd test-snap
  snapcraft init

  #shellcheck source=tests/spread/tools/snapcraft-yaml.sh
  . "$TOOLS_DIR/snapcraft-yaml.sh"
  set_base "snap/snapcraft.yaml"

  echo "compression: ${COMPRESSION}" >> snap/snapcraft.yaml

restore: |
  pushd test-snap
  # The regular clean can potentially fail depending on if/when the test itself failed, but
  # they should always both be attempted
  snapcraft clean --use-lxd || true
  snapcraft clean --destructive-mode
  rm -rf ./*.snap
  popd
  rm -rf test-snap

execute: |
  cd test-snap

  # First with lxd
  snapcraft $COMMAND --use-lxd
  unsquashfs -s ./*.snap | grep Compression | MATCH "${COMPRESSION}"
  rm ./*.snap

  # Then on host.
  snapcraft $COMMAND --destructive-mode
  unsquashfs -s ./*.snap | grep Compression | MATCH "${COMPRESSION}"
