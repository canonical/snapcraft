summary: Build snaps that test the grammar keywords.

prepare: |
  #shellcheck source=tests/spread/tools/snapcraft-yaml.sh
  . "$TOOLS_DIR/snapcraft-yaml.sh"
  set_base "./snap/snapcraft.yaml"

restore: |
  snapcraft clean --destructive-mode
  rm -f ./*.snap

  #shellcheck source=tests/spread/tools/snapcraft-yaml.sh
  . "$TOOLS_DIR/snapcraft-yaml.sh"
  restore_yaml "snap/snapcraft.yaml"

execute: |
  # first, run `snapcraft prime` for amd64
  SNAPCRAFT_BUILD_FOR=amd64 snapcraft prime --destructive-mode

  # verify `on amd64 to amd64` grammar was processed
  if ! grep "I was built on amd64 and built for amd64." prime/hello-world.sh; then
    echo "Grammar was not processed as expected!"
    exit 1
  fi

  # next, run `snapcraft prime` for arm64
  SNAPCRAFT_BUILD_FOR=arm64 snapcraft prime --destructive-mode

  # verify `on amd64 to arm64` grammar was processed
  if ! grep "I was built on amd64 and built for arm64." prime/hello-world.sh; then
    echo "Grammar was not processed as expected!"
    exit 1
  fi
