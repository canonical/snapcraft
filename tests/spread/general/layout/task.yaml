summary: Build a snap that uses layout

# core18 is the only stable base right now
systems: [ubuntu-18.04*]

environment:
  SNAP_DIR: snaps/layout-test

prepare: |
  . "$TOOLS_DIR/snapcraft-yaml.sh"
  set_base "$SNAP_DIR/snap/snapcraft.yaml"

restore: |
  cd "$SNAP_DIR"
  snapcraft clean
  rm -f ./*.snap

  . "$TOOLS_DIR/snapcraft-yaml.sh"
  restore_yaml "snap/snapcraft.yaml"

execute: |
  cd "$SNAP_DIR"
  output="$(snapcraft prime)"
  echo "$output" | MATCH "Layouts are experimental and may break, use at your own risk"

  # Verify that layouts made it into the final snap.yaml
  cat << EOF > expected.txt
  layout:
    /etc/test-dir:
      bind: $SNAP/test-dir
  EOF

  grep -A2 "layout:" prime/meta/snap.yaml > actual.txt
  comm -3 expected.txt actual.txt
