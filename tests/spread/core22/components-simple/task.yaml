summary: Build a snap with components

prepare: |
  snap refresh snapd --edge

restore: |
  snapcraft clean --destructive-mode
  rm -f ./*.snap ./*.comp
  snap refresh snapd --stable

execute: |
  snapcraft pack --destructive-mode

  # assert contents of default partition
  unsquashfs -dest "snap-contents" "snap-with-components_1.0_amd64.snap"
  if [[ ! -e "snap-contents/bin/hello" ]]; then
    echo "Expected file to exist but is does not exist."
    exit 1
  fi

  # assert component was packed
  component_file="snap-with-components+share_1.0.comp"
  if [[ ! -e "${component_file}" ]]; then
    echo "Expected component to exist but is does not exist."
    exit 1
  fi

  # assert contents of component/share
  unsquashfs -dest "component-contents" "${component_file}"
  if [[ ! -d "component-contents/usr/share" ]]; then
    echo "Expected directory to exist but is does not exist."
    exit 1
  fi

  # assert contents of component metadata
  if ! diff component-contents/meta/component.yaml expected-component.yaml; then
    echo "Metadata for the share component is incorrect."
    exit 1
  fi
