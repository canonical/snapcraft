summary: >-
  Verify python symlinks with different base and confinement
  configurations

environment:
  # These must run in managed mode in order to have the right Python versions
  SNAPCRAFT_BUILD_ENVIRONMENT: ""

  # base core24, strict confinement: use provisioned if available
  SNAP/strict_not_provisioned: strict-not-provisioned
  SNAP/strict_provisioned: strict-provisioned

  # base core24, classic confinement: requires provisioning
  SNAP/classic_not_provisioned: classic-not-provisioned
  SNAP/classic_provisioned: classic-provisioned

  # base core24, devmode: same as strict
  SNAP/devmode_not_provisioned: devmode-not-provisioned
  SNAP/devmode_provisioned: devmode-provisioned

  # base bare: requires provisioning
  SNAP/bare_not_provisioned: bare-not-provisioned
  SNAP/bare_provisioned: bare-provisioned

  # provisioned from a different part
  SNAP/provisioned_from_another_part: provisioned-from-another-part

  # using the gnome extension
  SNAP/strict_gnome_extension: strict-gnome-extension

restore: |
  cd "${SNAP}"
  snapcraft clean
  rm -f ./*.snap
  rm -rf ./squashfs-root

execute: |
  cd "${SNAP}"

  if [ -f expected-symlink ]; then
    snapcraft pack
    unsquashfs ${SNAP}_1.0_amd64.snap
    ls -l squashfs-root/bin
    [ -x squashfs-root/bin/hello ]
    [ "$(readlink squashfs-root/bin/python3)" == "$(cat expected-symlink)" ]
  else
    snapcraft prime 2>&1 | MATCH "No suitable Python interpreter found, giving up."
  fi
