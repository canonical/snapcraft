image: Visual Studio 2019
environment:
  matrix:
  - PYTHON: C:\\Python37-x64

clone_depth: 1
cache:
- '%LOCALAPPDATA%\pip\Cache\http'
- '%LOCALAPPDATA%\pip\Cache\wheels'
build: off

before_test:
- cmd: |
    %PYTHON%\\python.exe -m venv venv
    venv\\Scripts\\activate.bat
    ECHO %VIRTUAL_ENV%
    python -c "import sys; print(sys.executable)"
    python -m pip install -r requirements.txt
    python -m pip install -r requirements-devel.txt
    python -m pip install --prefix %VIRTUAL_ENV% -e .

test_script:
- cmd: |
    venv\\Scripts\\activate.bat
    ECHO %VIRTUAL_ENV%

after_test:
- cmd: |
    venv\\Scripts\\activate.bat
    ECHO %VIRTUAL_ENV%

    ECHO "Building snapcraft.exe..."
    pyinstaller.exe --onefile snapcraft.spec

    ECHO "Test signing snapcraft.exe..."
    powershell.exe tools\generate-self-signed-cert.ps1
    'C:\Program Files (x86)\Windows Kits\10\App Certification Kit\signtool.exe' sign /T 'http://timestamp.verisign.com/scripts/timstamp.dll' /F test-signing.pfx /P Password1234 dist\snapcraft.exe

    ECHO "Downloading multipass installer..."
    curl.exe -fsS 'https://github.com/CanonicalLtd/multipass/releases/download/v0.8.0/multipass-0.8.0+win-win64.exe' -o 'dist\multipass-0.8.0+win-win64.exe'

    ECHO "Building snapcraft installer..."
    'C:\Program Files (x86)\Inno Setup 6\iscc.exe' .\snapcraft.iss

    ECHO "Test signing snapcraft installer..."
    'C:\Program Files (x86)\Windows Kits\10\App Certification Kit\signtool.exe' sign /T 'http://timestamp.verisign.com/scripts/timstamp.dll' /F test-signing.pfx /P Password1234 dist\snapcraft-installer.exe

artifacts:
- path: dist\*
