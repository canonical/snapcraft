image: Visual Studio 2019
environment:
  INNOCC: C:\Program Files (x86)\Inno Setup 6\iscc.exe
  MAKEAPPX: C:\Program Files (x86)\Windows Kits\10\bin\10.0.18362.0\x64\makeappx.exe
  SIGNTOOL: C:\Program Files (x86)\Windows Kits\10\bin\10.0.18362.0\x64\signtool.exe

  MULTIPASS_URL: https://github.com/CanonicalLtd/multipass/releases/download/v0.8.0/multipass-0.8.0+win-win64.exe
  MULTIPASS_PATH: dist\\multipass-0.8.0+win-win64.exe

  matrix:
  - PYTHON: C:\\Python37-x64

clone_depth: 1
cache:
- '%LOCALAPPDATA%\pip\Cache\http'
- '%LOCALAPPDATA%\pip\Cache\wheels'
build: off

before_test:
- cmd: |
    %PYTHON%\\python.exe -m venv venv
    venv\\Scripts\\activate.bat
    ECHO %VIRTUAL_ENV%
    python -c "import sys; print(sys.executable)"
    python -m pip install -r requirements.txt
    python -m pip install -r requirements-devel.txt
    python -m pip install --prefix %VIRTUAL_ENV% -e .

test_script:
- cmd: |
    venv\\Scripts\\activate.bat
    ECHO %VIRTUAL_ENV%

after_test:
- cmd: |
    venv\\Scripts\\activate.bat
    ECHO %VIRTUAL_ENV%

    ECHO "Building snapcraft.exe..."
    pyinstaller.exe --onefile snapcraft.spec

    ECHO "Test signing snapcraft.exe..."
    powershell.exe windows\\generate-self-signed-cert.ps1
    "%SIGNTOOL%" sign /fd SHA256 /T "http://timestamp.verisign.com/scripts/timstamp.dll" /F test-signing.pfx /P Password1234 dist\\snapcraft.exe

    ECHO "Downloading multipass installer..."
    appveyor DownloadFile "%MULTIPASS_URL%" -FileName "%MULTIPASS_PATH%"

    ECHO "Building snapcraft inno installer..."
    "%INNOCC%" windows\\snapcraft.iss

    ECHO "Test signing snapcraft inno installer..."
    "%SIGNTOOL%" sign /fd SHA256 /T "http://timestamp.verisign.com/scripts/timstamp.dll" /F test-signing.pfx /P Password1234 dist\\snapcraft-installer.exe

    ECHO "Building snapcraft msix installer..."
    mkdir dist\\msix
    copy dist\\snapcraft.exe dist\\msix\\
    copy windows\\snapcraft.png dist\\msix\\
    copy windows\\AppxManifest.xml dist\\msix\\
    %MAKEAPPX% pack /h SHA256 /d dist\\msix /p dist\\snapcraft-installer.msix

    ECHO "Test signing snapcraft msix installer..."
    "%SIGNTOOL%" sign /fd SHA256 /T "http://timestamp.verisign.com/scripts/timstamp.dll" /F test-signing.pfx /P Password1234 dist\\snapcraft-installer.msix


artifacts:
- path: dist\*
