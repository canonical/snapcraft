sudo: required
dist: trusty
language: python
python:
  - 3.4
virtualenv:
  system_site_packages: true
env:
  matrix:
  - DIST=trusty TEST_SUITE=unit
  - DIST=vivid TEST_SUITE=unit
  - DIST=trusty TEST_SUITE=plainbox
  - DIST=vivid TEST_SUITE=plainbox
  - DIST=trusty TEST_SUITE="examples --skip-install"
  - DIST=vivid TEST_SUITE="examples --skip-install"

install:
  - sudo apt-add-repository -y ppa:ubuntu-lxc/lxd-stable
  - sudo apt-get update -qq
  - sudo apt-get -o Dpkg::Options::="--force-confnew" -y dist-upgrade || true
  - sudo apt-get install -qq lxd lxcfs || true
before_script:
  - sudo lxd-images import ubuntu $DIST --stream daily --alias ubuntu
  - sudo lxc launch ubuntu $DIST
  # Wait for the container to get an IP address.
  - while ! sudo lxc info $DIST | grep -q eth0.*IPV4; do sleep 5s; done
  # Allow the container user to do everything on the repository.
  - sudo chmod 777 $(pwd)
  # Mount the repository directory in the container.
  - sudo lxc config device add $DIST /dev/sda1 disk source=$(pwd) path=$(pwd)
  # PPA for plainbox.
  - sudo lxc exec $DIST -- apt-add-repository -y ppa:hardware-certification/public
  # PPA for snappy.
  - sudo lxc exec $DIST -- apt-add-repository -y ppa:snappy-dev/tools-proposed
  - sudo lxc exec $DIST -- apt-get update
  - sudo lxc exec xenial -- apt-get install -y devscripts equivs
  - sudo lxc exec xenial -- mk-build-deps --install --tool "apt-get -y" --build-dep debian/control
  - sudo lxc exec $DIST -- apt-get install -y build-essential dpkg-dev git mercurial plainbox pyflakes python3-coverage python3-mccabe python3-pep8 python3-pip python3-testtools
script:
  - sudo lxc exec $DIST -- su - ubuntu -c "cd $(pwd); ./runtests.sh $TEST_SUITE'"
after_success:
  - sudo apt-get install -qq python3-coverage || true
  - pip install coveralls
  - coveralls
