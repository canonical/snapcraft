sudo: required
dist: trusty
language: python
python:
  - 3.4
virtualenv:
  system_site_packages: true
env:
  global:
  # Encrypted Coveralls token. The secret token for your repository can be found at the
  # bottom of your repository's page on Coveralls. To encrypt it, install the travis gem
  # and run:
  #     travis encrypt -r ubuntu-core/snappy COVERALLS_TOKEN=$secret_token
  - secure: JJEh1YfzNJGb1//ca447JtRunHmNXsVDGy5fS882/RQV3XtS9mCaSS+PZF4AbVABSiDw96mvwv05KmhdgV575y0NVHuRPd3rJBku9HOmhOKfCykn5tXgVJUEgeW5HIPusltRkXJUxnm48l+RfHHJU1h6iJnpGjvwxygeQljM4d22+G493ymvv4KZJSnbtuDbmhWvnZtdV2cCFeZ+EWqLgyWaFQmMgeMkYYcY3Cy19d++WquLs4woN9S9szrXJQlIv3xuZ8XNLbWmHoe6uD4y1Fn7YYfRgz861KqusxcGO9OyCh1S6uLgDuETS4Uw2zBg77vv59jSJieEfcY8jQtFE65axot/90jwhp5IV0tIpd9O/AMZXIGqKk44RU+Sj9gDbPbBIhj9dew3BTwSuOcNITSg1a4sOkxHGyIj2NozCkgFqPq0d4RM7xRrOYfnmjP1sJ+tEH4XMbs4gNZ/abccJXeUx6i5qWhDdnix132C62vvl+ItnsfMtkXQ34hluYxoab+rS0Zz3MM/ENqHySvU/R2n7+WTVXHyoK55HvExX7Y+McqPU2uVsHDabmDmQfcYom9nDY1OTBM3JbTOuqtIrzSIlFYdogyttXrTsmSue8TAoWWnHirKdkzeskIs5ZbI/pfGV3eRol+9Mn0MtmaoLp1VrAtSiZYwPRdcIGBDNMQ=
  matrix:
  - TEST_SUITE=unit
  - TEST_SUITE=integration
  - TEST_SUITE="examples --skip-install"

install:
  - sudo apt-add-repository -y ppa:ubuntu-lxc/lxd-stable
  - sudo apt-get update -qq
  - sudo apt-get -o Dpkg::Options::="--force-confnew" -y dist-upgrade
  - sudo apt-get install -qq lxd lxcfs
  # newgrp will ask for a password. Use usermod and sudo -E instead, as
  # explained in the travis docs:
  # https://docs.travis-ci.com/user/trusty-ci-environment/#Group-membership
  - sudo usermod -a -G lxd $USER
before_script:
  - sudo -E su $USER -c "lxd-images import ubuntu xenial --stream daily --alias ubuntu"
  - sudo -E su $USER -c "lxc launch ubuntu xenial"
  # Wait for the container to get an IP address.
  - while ! sudo lxc info xenial | grep -q eth0.*IPV4; do sleep 5s; done
  # Allow the container user to do everything on the repository.
  - sudo chmod -R 777 $(pwd)
  # Mount the repository directory in the container.
  - sudo -E su $USER -c "lxc config device add xenial /dev/sda1 disk source=$(pwd) path=/home/ubuntu"
  - sudo -E su $USER -c "lxc exec xenial -- apt-get update"
  - sudo -E su $USER -c "lxc exec xenial -- apt-get install -y build-essential bzr dpkg-dev git mercurial pyflakes python3.4 python3-apt python3-docopt python3-coverage python3-fixtures python3-jsonschema python3-mccabe python3-pep8 python3-pip python3-requests python3-testscenarios python3-testtools python3-yaml python3-lxml squashfs-tools"
script:
  - sudo -E su $USER -c "lxc exec xenial -- su - ubuntu -c 'cd /home/ubuntu; ./runtests.sh $TEST_SUITE'"
after_success:
  - sudo apt-get install -qq python3-docopt python3-coverage python3-requests
  - pip install coveralls
  - sudo chmod 777 .coverage
  - sudo chown $USER:$USER .coverage
  - COVERALLS_REPO_TOKEN=$COVERALLS_TOKEN coveralls
