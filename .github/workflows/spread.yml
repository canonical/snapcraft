name: Spread Tests

on: [pull_request]

jobs:
  integration-spread-tests:
    runs-on: self-hosted
    strategy:
      # FIXME: enable fail-fast mode once spread can cancel an executing job.
      # Disable fail-fast mode as it doesn't function with spread. It seems
      # that cancelling tasks requires short, interruptible actions and
      # interrupting spread, notably, does not work today. As such disable
      # fail-fast while we tackle that problem upstream.
      fail-fast: false
      matrix:
        spread-jobs:
          - google:ubuntu-18.04-64

    steps:
      - name: Try to get core dump from Flutter
        if: always()
        run: |
          sudo apt-get install gdb curl
          cd /tmp/
          mkdir flutter
          cd flutter
          curl -O https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.13.2-stable.tar.xz
          tar xf flutter_linux_3.13.2-stable.tar.xz
          export PATH="$PATH:`pwd`/flutter/bin"
          ulimit -c unlimited
          cat /proc/sys/kernel/core_pattern
          flutter channel dev || true
          shopts -s nullglob
          for f in core*; do
            gdb -ex 'frame apply all x/2i $pc' -ex 'exit' -quiet flutter/bin/cache/dart-sdk/bin/dart $f
          done
          cd ..
          rm -rf flutter
