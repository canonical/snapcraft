name: snapcraft
summary: easily create snaps
description: |
    Snapcraft aims to make upstream developers' lives easier and as such is not
    a single toolset, but instead is a collection of tools that enable the
    natural workflow of an upstream to be extended with a simple release step
    into Snappy.
base: core18
adopt-info: snapcraft
confinement: classic

apps:
  snapcraft:
    command: bin/snapcraft
    completer: snapcraft-completion

build-packages:
  - build-essential
  - intltool
  - libapt-pkg-dev
  - libffi-dev
  - libssl-dev
  - libsodium-dev
  - liblzma-dev
  - libxml2-dev
  - libxslt-dev
  - libyaml-dev
  - patch
  - sed

parts:
  bash-completion:
    source: debian
    plugin: dump
    stage:
      - snapcraft-completion

  snapcraft-libs:
    plugin: nil
    stage-packages:
        - apt
        - apt-transport-https
        - apt-utils
        - binutils
        - execstack
        - gpgv
        - libffi6
        - libsodium23
        - libxml2
        - libxslt1.1
        - patchelf
        - squashfs-tools
        - xdelta3
    override-build: |
      snapcraftctl build

      echo "Create libsodium symlink..."
      TRIPLET_PATH="$SNAPCRAFT_PART_INSTALL/usr/lib/$(gcc -print-multiarch)"
      LIBSODIUM="$(readlink -n "$TRIPLET_PATH/libsodium.so.23")"
      # Remove so the link can be recreated on re-builds
      rm -f "$TRIPLET_PATH/libsodium.so"
      ln -s "$LIBSODIUM" "$TRIPLET_PATH/libsodium.so"

  snapcraft:
    source: .
    plugin: python
    requirements: 
    - requirements.txt
    organize:
        # Put snapcraftctl into its own directory that can be included in the PATH
        # without including other binaries.
        bin/snapcraftctl: bin/scriptlet-bin/snapcraftctl
    override-pull: |
        snapcraftctl pull
        version="$(git describe --always | sed -e 's/-/+git/;y/-/./')"
        [ -n "$(echo $version | grep "+git")" ] && grade=devel || grade=stable
        snapcraftctl set-version "$version"
        snapcraftctl set-grade "$grade"
    override-build: |
        snapcraftctl build

        # Restore patched files
        PYTHON_PACKAGE_PATH="$SNAPCRAFT_PART_INSTALL/usr/lib/python3.6/"
        [ -f "patched/ctypes/__init__.py.orig" ] && mv "patched/ctypes/__init__.py.orig" "$PYTHON_PACKAGE_PATH/ctypes/__init__.py"

        # Apply patches
        echo "Patching ctypes..."
        patch -s -b "$PYTHON_PACKAGE_PATH/ctypes/__init__.py" patches/ctypes_init.diff

        # Save patches to allow rebuilding
        mkdir -p patched/ctypes
        [ -f "$PYTHON_PACKAGE_PATH/ctypes/__init__.py.orig" ] && mv "$PYTHON_PACKAGE_PATH/ctypes/__init__.py.orig" patched/ctypes

        sed -i "$SNAPCRAFT_PART_INSTALL/usr/lib/python3.6/site.py" -e 's/^ENABLE_USER_SITE = None$/ENABLE_USER_SITE = False/'
    override-prime: |
        snapcraftctl prime

        echo "Compiling pyc files..."
        # This is the last step, let's now compile all our pyc files.
        "$SNAPCRAFT_PART_INSTALL/usr/bin/python3" -m compileall -q .

    after: [snapcraft-libs]

  legacy-snapcraft:
    plugin: python
    source: https://github.com/snapcore/snapcraft.git
    source-branch: legacy
    source-depth: 1
    requirements:
    - requirements.txt
    override-build: |
        snapcraftctl build

        # Restore patched files
        PYTHON_PACKAGE_PATH="$SNAPCRAFT_PART_INSTALL/usr/lib/python3.6/"
        [ -f "patched/ctypes/__init__.py.orig" ] && mv "patched/ctypes/__init__.py.orig" "$PYTHON_PACKAGE_PATH/ctypes/__init__.py"

        # Apply patches
        echo "Patching ctypes..."
        patch -s -b "$PYTHON_PACKAGE_PATH/ctypes/__init__.py" patches/ctypes_init.diff

        # Save patches to allow rebuilding
        mkdir -p patched/ctypes
        [ -f "$PYTHON_PACKAGE_PATH/ctypes/__init__.py.orig" ] && mv "$PYTHON_PACKAGE_PATH/ctypes/__init__.py.orig" patched/ctypes

        sed -i "$SNAPCRAFT_PART_INSTALL/usr/lib/python3.6/site.py" -e 's/^ENABLE_USER_SITE = None$/ENABLE_USER_SITE = False/'

        sed -ri 's|(lib/.*/site-packages)|legacy_snapcraft/\1|' $SNAPCRAFT_PART_INSTALL/usr/lib/python3.6/sitecustomize.py
    organize:
        '*': legacy_snapcraft/
    after: [snapcraft-libs]
