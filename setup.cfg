[codespell]
ignore-words-list = buildd,crate,keyserver,comandos,ro
skip = waf,*.tar,*.xz,*.zip,*.bz2,*.7z,*.gz,*.deb,*.rpm,*.snap,*.gpg,*.pyc,*.png,*.ico,*.jar,*.so,changelog,.git,.hg,.mypy_cache,.tox,.venv,venv,_build,buck-out,__pycache__,build,dist,.vscode,parts,stage,prime,test_appstream.py,./snapcraft.spec,./.direnv,./.pytest_cache
quiet-level = 4

[flake8]
# E501 line too long
# E203 whitespace before ':'
extend-ignore = E203, E501
max-complexity = 10
max-line-length = 88
exclude =
    # No need to traverse our git directory
    .direnv,
    .git,
    .hg,
    .mypy_cache,
    .tox,
    .venv,
    .vscode,
    _build,
    buck-out,
    # There's no value in checking cache directories
    __pycache__,
    # This contains builds of flake8 that we don't want to check
    build,
    dist,
    # snapcraft generated
    parts,
    stage,
    prime

[pycodestyle]
max-line-length = 88
ignore = E203,E501

[pydocstyle]
# D107 Missing docstring in __init__ (reason: documented in class docstring)
# D203 1 blank line required before class docstring (reason: pep257 default)
# D213 Multi-line docstring summary should start at the second line (reason: pep257 default)
ignore = D107, D203, D213
ignore_decorators = overrides

[tox:tox]
min_version = 4.0
env_list =
    # Parametrized environments.
    # First parameter allows us to choose Python 3.8 or 3.10.
    # Second parameter chooses how to define the environment:
    #  dev: using requirements-devel.txt
    #  noreq: Without either requirements file (but including dev requirements)
    # Third parameter selects the current unit tests (unit) or the legacy unit tests (legacy)
    py{38,310}-{dev,noreq}-{unit,legacy}
skip_missing_interpreters = true
labels =
    # Minimal testing environments. run with `tox run-parallel -m test`
    test = py38-dev-unit,py38-dev-legacy
    # Test in Python 3.10 from an empty environment.
    future-test = py310-noreq-unit,py310-noreq-legacy

[gh-actions]
python =
    3.8: py38
    3.10: py310

[testenv]
package = wheel
wheel_build_env = .pkg
deps =
    dev,pylint,ci: -r{tox_root}/requirements-devel.txt
    noreq,pyright: python-apt@ https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/python-apt/2.0.0ubuntu0.20.04.8/python-apt_2.0.0ubuntu0.20.04.8.tar.xz

[testenv:py{38,310}-noreq-unit]
description = Run the unit tests based on only the package's specifications
platform = linux
install_command = pip install --no-binary PyNaCl {opts} {packages}
extras = dev
commands =
    pytest {tty:--color=yes} --cov-report=xml:results/coverage-{env_name}.xml --junit-xml=results/test-results-{env_name}.xml tests/unit

[testenv:py{38,310}-noreq-legacy]
description = Run the legacy unit tests based on only the package's specifications
platform = linux
install_command = pip install --no-binary PyNaCl {opts} {packages}
extras = dev
commands =
    pytest {tty:--color=yes} --cov-report=xml:results/coverage-{env_name}.xml --junit-xml=results/test-results-{env_name}.xml tests/legacy/unit {posargs}

[testenv:py{38,310}-dev-unit]
description = Run the unit tests based on the relevant requirements file
labels = ci
commands =
    pytest {tty:--color=yes} --cov-report=xml:results/coverage-{env_name}.xml --junit-xml=results/test-results-{env_name}.xml tests/unit {posargs}

[testenv:py{38,310}-dev-legacy]
description = Run the legacy unit tests based on the relevant requirements file
labels = ci
commands =
    pytest {tty:--color=yes} --cov-report=xml:results/coverage-{env_name}.xml --junit-xml=results/test-results-{env_name}.xml tests/legacy/unit/ {posargs}

[testenv:format]
description = Format with black
labels = fix
deps = black
skip_install = true
# Note: this does not include `snapcraft_legacy` as it contains several files that need reformatting.
commands = black setup.py snapcraft tests

[testenv:mypy]
description = Run mypy
skip_install = true
labels = type, lint
deps = mypy
commands = mypy --install-types --non-interactive .

[testenv:pyright]
description = run PyRight
labels = type, lint
use_develop = true
extras = dev
allowlist_externals = pyright
commands = pyright snapcraft tests

[testenv:black]
description = run black in checking mode
skip_install = true
labels = lint
deps = black
commands = black --check --diff setup.py snapcraft tests

[testenv:codespell]
description = Check spelling with codespell
skip_install = true
labels = lint
deps = codespell
commands = codespell --quiet-level 4 --ignore-words-list crate,keyserver,comandos,ro,buildd --skip '*.tar,*.xz,*.zip,*.bz2,*.7z,*.gz,*.deb,*.rpm,*.snap,*.gpg,*.pyc,*.png,*.ico,*.jar,*.so,changelog,.git,.hg,.mypy_cache,.tox,.venv,venv,_build,buck-out,__pycache__,build,dist,.vscode,parts,stage,prime,test_appstream.py,./snapcraft.spec,./.direnv,./.pytest_cache,./tests/spread/plugins/v1/waf/snaps/waf-hello/waf'

[testenv:flake]
description = Lint with flake8
skip_install = true
labels = lint
deps = flake8<6.0
commands =
    flake8 .

[testenv:isort]
description = Check import order with isort
skip_install = true
labels = lint
deps = isort
commands = isort --check .

[testenv:docstyle]
description = Check documentation style with pydocstyle
skip_install = true
labels = lint
deps = pydocstyle
commands = pydocstyle snapcraft

[testenv:pylint]
description = Lint with pylint
labels = lint
skip_install = true
commands =
    pylint -j 0 snapcraft
	pylint -j 0 tests --disable=invalid-name,missing-module-docstring,missing-function-docstring,duplicate-code,protected-access,unspecified-encoding,too-many-public-methods,too-many-arguments,too-many-lines,redefined-outer-name

[testenv:spellcheck]
description = Check spelling using spread-shellcheck.py
labels = lint
deps = pyyaml
skip_install = true
commands =
    python3 tools/spread-shellcheck.py spread.yaml tests/spread/

[testenv:shellcheck]
description = Check spelling with shellcheck
labels = lint
skip_install = true
allowlist_externals = bash
commands =
    bash -c "find . \( -name .git -o -name gradlew -o -name .tox \) -prune -o -print0 | xargs -0 file -N | grep shell.script | cut -f1 -d: | xargs shellcheck"
